name: Deploy to Cloudflare Pages and Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_database_seed:
        description: 'Skip database seeding (set to true to skip)'
        required: false
        default: 'false'

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  D1_DATABASE_NAME: 'vaultcloud-db'
  KV_NAMESPACE_NAME: 'vaultcloud-sessions'
  PAGES_PROJECT_NAME: 'vaultcloud'

jobs:
  setup-infrastructure:
    runs-on: ubuntu-latest
    name: Setup Cloudflare Infrastructure
    outputs:
      d1_database_id: ${{ steps.setup.outputs.d1_database_id }}
      kv_namespace_id: ${{ steps.setup.outputs.kv_namespace_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Cloudflare Resources
        id: setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”§ Setting up Cloudflare resources..."
          
          # Check and create D1 Database
          echo "ðŸ“Š Checking D1 Database..."
          D1_LIST=$(npx wrangler d1 list 2>&1)
          
          # Check if database exists
          if echo "$D1_LIST" | grep -q "$D1_DATABASE_NAME"; then
            # Extract UUID from the list output
            D1_ID=$(echo "$D1_LIST" | grep "$D1_DATABASE_NAME" | grep -oP '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -n 1)
            echo "âœ… D1 Database already exists: $D1_ID"
          else
            echo "Creating new D1 database: $D1_DATABASE_NAME"
            D1_OUTPUT=$(npx wrangler d1 create "$D1_DATABASE_NAME" 2>&1)
            echo "$D1_OUTPUT"
            
            # Extract database_id from output
            D1_ID=$(echo "$D1_OUTPUT" | grep -oP 'database_id\s*=\s*"\K[^"]+' || echo "$D1_OUTPUT" | grep -oP '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -n 1)
            
            if [ -z "$D1_ID" ]; then
              echo "âŒ Failed to extract D1 database ID"
              echo "Output was: $D1_OUTPUT"
              exit 1
            fi
            
            echo "âœ… D1 Database created: $D1_ID"
          fi
          
          echo "d1_database_id=$D1_ID" >> $GITHUB_OUTPUT
          
          # Check and create KV Namespace
          echo "ðŸ—„ï¸ Checking KV Namespace..."
          KV_LIST=$(npx wrangler kv namespace list 2>&1 || echo "[]")
          echo "Debug - KV List output:"
          echo "$KV_LIST"
          
          # Check if output is JSON and parse it
          if echo "$KV_LIST" | jq -e . >/dev/null 2>&1; then
            # Valid JSON - use jq to parse
            KV_ID=$(echo "$KV_LIST" | jq -r ".[] | select(.title==\"$KV_NAMESPACE_NAME\") | .id" 2>/dev/null || echo "")
            
            if [ -n "$KV_ID" ] && [ "$KV_ID" != "null" ]; then
              echo "âœ… KV Namespace already exists: $KV_ID"
            else
              echo "KV namespace not found, will create"
              KV_ID=""
            fi
          else
            # Not JSON, try text parsing
            if echo "$KV_LIST" | grep -qi "$KV_NAMESPACE_NAME"; then
              KV_ID=$(echo "$KV_LIST" | grep -i "$KV_NAMESPACE_NAME" | grep -oP 'id\s*=\s*"\K[^"]+' || \
                      echo "$KV_LIST" | grep -i "$KV_NAMESPACE_NAME" | grep -oP '\b[a-f0-9]{32}\b' | head -n 1)
              
              if [ -n "$KV_ID" ] && [ "$KV_ID" != "null" ]; then
                echo "âœ… KV Namespace already exists: $KV_ID"
              else
                KV_ID=""
              fi
            fi
          fi
          
          # Create KV namespace if not found
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "Creating new KV namespace: $KV_NAMESPACE_NAME"
            KV_OUTPUT=$(npx wrangler kv namespace create "$KV_NAMESPACE_NAME" 2>&1)
            echo "$KV_OUTPUT"
            
            # Try to parse output as JSON first
            if echo "$KV_OUTPUT" | jq -e . >/dev/null 2>&1; then
              KV_ID=$(echo "$KV_OUTPUT" | jq -r '.id // empty' 2>/dev/null || echo "")
            fi
            
            # If JSON parsing failed, try text patterns
            if [ -z "$KV_ID" ]; then
              KV_ID=$(echo "$KV_OUTPUT" | grep -oP 'id\s*=\s*"\K[^"]+' || \
                      echo "$KV_OUTPUT" | grep -oP '"id"\s*:\s*"\K[^"]+' || \
                      echo "$KV_OUTPUT" | grep -oP '\b[a-f0-9]{32}\b' | head -n 1 || \
                      echo "")
            fi
            
            if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
              echo "âŒ Failed to extract KV namespace ID"
              echo "Output was: $KV_OUTPUT"
              echo "âš ï¸ You may need to create KV namespace manually and update wrangler.toml"
              echo "âš ï¸ Command: wrangler kv namespace create $KV_NAMESPACE_NAME"
              exit 1
            else
              echo "âœ… KV Namespace created: $KV_ID"
            fi
          fi
          
          echo "kv_namespace_id=$KV_ID" >> $GITHUB_OUTPUT
          
          echo "âœ¨ Infrastructure setup complete!"

      - name: Update wrangler.toml
        run: |
          echo "ðŸ“ Updating wrangler.toml with resource IDs..."
          
          # Update D1 database ID
          sed -i "s/database_id = \".*\"/database_id = \"${{ steps.setup.outputs.d1_database_id }}\"/" wrangler.toml
          
          # Update KV namespace ID
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ steps.setup.outputs.kv_namespace_id }}\"/" wrangler.toml
          
          echo "âœ… wrangler.toml updated"
          cat wrangler.toml

  setup-database:
    runs-on: ubuntu-latest
    name: Setup Database Schema and Seed Data
    needs: setup-infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update wrangler.toml for database operations
        run: |
          sed -i "s/database_id = \".*\"/database_id = \"${{ needs.setup-infrastructure.outputs.d1_database_id }}\"/" wrangler.toml
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ needs.setup-infrastructure.outputs.kv_namespace_id }}\"/" wrangler.toml

      - name: Run Database Schema Migration
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ—„ï¸ Running database schema migration..."
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/schema.sql --remote
          echo "âœ… Schema migration complete"

      - name: Run Database Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”„ Running additional migrations..."
          
          # Migration 002 - FIDO enhancements (may fail if already applied)
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/migration_002_fido_enhancements.sql --remote || echo "âš ï¸ Migration 002 skipped (possibly already applied)"
          
          # Migration 003 - Site settings (may fail if already applied)
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/migration_003_site_settings.sql --remote || echo "âš ï¸ Migration 003 skipped (possibly already applied)"
          
          # Migration 004 - User profile management (may fail if already applied)
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/migration_004_user_profile_changes.sql --remote || echo "âš ï¸ Migration 004 skipped (possibly already applied)"
          
          echo "âœ… Migrations complete"

      - name: Seed Database
        if: github.event.inputs.skip_database_seed != 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸŒ± Seeding database with initial data..."
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/seed.sql --remote
          echo "âœ… Database seeded successfully"
          echo "âš ï¸ Default users created:"
          echo "  - Admin: admin@vaultcloud.dev / admin123"
          echo "  - User: user@vaultcloud.dev / user123"

  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy Worker API
    needs: [setup-infrastructure, setup-database]
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update wrangler.toml for deployment
        run: |
          sed -i "s/database_id = \".*\"/database_id = \"${{ needs.setup-infrastructure.outputs.d1_database_id }}\"/" wrangler.toml
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ needs.setup-infrastructure.outputs.kv_namespace_id }}\"/" wrangler.toml
          
          # Set production environment
          sed -i 's/ENVIRONMENT = "development"/ENVIRONMENT = "production"/' wrangler.toml

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Setting worker secrets..."
          
          # Set JWT secret
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | npx wrangler secret put JWT_SECRET
          fi
          
          # Set encryption key
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then
            echo "${{ secrets.ENCRYPTION_KEY }}" | npx wrangler secret put ENCRYPTION_KEY
          fi
          
          # Set Resend API key (optional)
          if [ -n "${{ secrets.RESEND_API_KEY }}" ]; then
            echo "${{ secrets.RESEND_API_KEY }}" | npx wrangler secret put RESEND_API_KEY
          fi
          
          echo "âœ… Secrets configured"

      - name: Deploy Worker
        id: deploy-worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          packageManager: npm

      - name: Get Worker URL
        id: worker-url
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Getting actual Worker URL..."
          
          # Method 1: Get from Cloudflare API
          WORKER_INFO=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/scripts/vaultcloud-api" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          echo "Worker info response:"
          echo "$WORKER_INFO" | jq '.' || echo "$WORKER_INFO"
          
          # Try to get subdomain info
          SUBDOMAIN_INFO=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/subdomain" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          echo "Subdomain info:"
          echo "$SUBDOMAIN_INFO" | jq '.' || echo "$SUBDOMAIN_INFO"
          
          # Extract subdomain
          SUBDOMAIN=$(echo "$SUBDOMAIN_INFO" | jq -r '.result.subdomain // empty' 2>/dev/null)
          
          if [ -n "$SUBDOMAIN" ] && [ "$SUBDOMAIN" != "null" ]; then
            WORKER_URL="https://vaultcloud-api.$SUBDOMAIN.workers.dev"
            echo "âœ… Constructed Worker URL from subdomain: $WORKER_URL"
          else
            # Method 2: Try wrangler deployments
            echo "âš ï¸ Subdomain not found via API, trying wrangler..."
            DEPLOY_LIST=$(npx wrangler deployments list 2>&1 || echo "")
            
            if echo "$DEPLOY_LIST" | grep -q "https://"; then
              WORKER_URL=$(echo "$DEPLOY_LIST" | grep -oP 'https://[a-z0-9-]+\.[a-z0-9-]+\.workers\.dev' | head -n 1)
              echo "âœ… Found Worker URL from deployments: $WORKER_URL"
            fi
          fi
          
          # Fallback
          if [ -z "$WORKER_URL" ]; then
            echo "âš ï¸ Could not determine Worker URL automatically"
            echo "Please set VITE_API_URL secret with your actual Worker URL"
            WORKER_URL="https://vaultcloud-api.steep-morning-8706.workers.dev"
          fi
          
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Worker URL: $WORKER_URL"
          
          # Save to file for next job
          echo "$WORKER_URL" > worker_url.txt

      - name: Upload Worker URL
        uses: actions/upload-artifact@v4
        with:
          name: worker-url
          path: worker_url.txt
          retention-days: 1

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend to Cloudflare Pages
    needs: deploy-worker
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Worker URL
        uses: actions/download-artifact@v4
        with:
          name: worker-url

      - name: Build frontend
        run: |
          echo "ðŸ—ï¸ Building frontend..."
          
          # Get Worker URL from artifact or use secret
          if [ -f worker_url.txt ]; then
            WORKER_URL=$(cat worker_url.txt)
            echo "âœ… Using Worker URL from deployment: $WORKER_URL"
          elif [ -n "${{ secrets.VITE_API_URL }}" ]; then
            WORKER_URL="${{ secrets.VITE_API_URL }}"
            echo "âœ… Using Worker URL from secret: $WORKER_URL"
          else
            echo "âš ï¸ No Worker URL found, using default"
            WORKER_URL="https://vaultcloud-api.steep-morning-8706.workers.dev"
          fi
          
          # Add /api suffix if not present
          if [[ ! "$WORKER_URL" =~ /api$ ]]; then
            WORKER_URL="${WORKER_URL}/api"
            echo "âœ… Added /api suffix: $WORKER_URL"
          fi
          
          export VITE_API_URL="$WORKER_URL"
          echo "API URL: $VITE_API_URL"
          
          npm run build
          echo "âœ… Build complete"

      - name: Create Pages Project if needed
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“„ Checking if Pages project exists..."
          
          # Check if project exists using wrangler
          PROJECT_CHECK=$(npx wrangler pages project list 2>&1 || echo "")
          
          if echo "$PROJECT_CHECK" | grep -q "$PAGES_PROJECT_NAME"; then
            echo "âœ… Pages project already exists"
          else
            echo "Creating Pages project: $PAGES_PROJECT_NAME"
            
            # Create project using wrangler
            npx wrangler pages project create "$PAGES_PROJECT_NAME" --production-branch=main || {
              echo "âš ï¸ Project creation via wrangler failed, will try via API"
              
              # Fallback: Create via Cloudflare API
              CREATE_RESPONSE=$(curl -s -X POST \
                "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects" \
                -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
                -H "Content-Type: application/json" \
                --data "{
                  \"name\": \"$PAGES_PROJECT_NAME\",
                  \"production_branch\": \"main\",
                  \"build_config\": {
                    \"build_command\": \"npm run build\",
                    \"destination_dir\": \"dist\",
                    \"root_dir\": \"/\"
                  }
                }")
              
              if echo "$CREATE_RESPONSE" | grep -q '"success":true'; then
                echo "âœ… Pages project created via API"
              else
                echo "âš ï¸ Could not create project, but Pages action may create it automatically"
                echo "Response: $CREATE_RESPONSE"
              fi
            }
          fi

      - name: Publish to Cloudflare Pages
        id: deploy-pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.PAGES_PROJECT_NAME }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-pages.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Worker**: https://vaultcloud-api.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **D1 Database**: ${{ needs.setup-infrastructure.outputs.d1_database_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **KV Namespace**: ${{ needs.setup-infrastructure.outputs.kv_namespace_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Security Notice" >> $GITHUB_STEP_SUMMARY
          echo "Default test users have been created. Please change passwords immediately!" >> $GITHUB_STEP_SUMMARY
