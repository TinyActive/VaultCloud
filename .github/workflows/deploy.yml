name: Deploy to Cloudflare Pages and Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_database_seed:
        description: 'Skip database seeding (set to true to skip)'
        required: false
        default: 'false'

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  D1_DATABASE_NAME: 'vaultcloud-db'
  KV_NAMESPACE_NAME: 'vaultcloud-sessions'
  PAGES_PROJECT_NAME: 'vaultcloud'

jobs:
  setup-infrastructure:
    runs-on: ubuntu-latest
    name: Setup Cloudflare Infrastructure
    outputs:
      d1_database_id: ${{ steps.setup.outputs.d1_database_id }}
      kv_namespace_id: ${{ steps.setup.outputs.kv_namespace_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Cloudflare Resources
        id: setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”§ Setting up Cloudflare resources..."
          
          # Check and create D1 Database
          echo "ðŸ“Š Checking D1 Database..."
          D1_LIST=$(npx wrangler d1 list --json 2>/dev/null || echo "[]")
          D1_ID=$(echo "$D1_LIST" | jq -r ".[] | select(.name==\"$D1_DATABASE_NAME\") | .uuid" | head -n 1)
          
          if [ -z "$D1_ID" ] || [ "$D1_ID" == "null" ]; then
            echo "Creating new D1 database: $D1_DATABASE_NAME"
            D1_CREATE=$(npx wrangler d1 create "$D1_DATABASE_NAME" --json)
            D1_ID=$(echo "$D1_CREATE" | jq -r '.uuid // .database_id // empty')
            echo "âœ… D1 Database created: $D1_ID"
          else
            echo "âœ… D1 Database already exists: $D1_ID"
          fi
          
          echo "d1_database_id=$D1_ID" >> $GITHUB_OUTPUT
          
          # Check and create KV Namespace
          echo "ðŸ—„ï¸ Checking KV Namespace..."
          KV_LIST=$(npx wrangler kv:namespace list --json 2>/dev/null || echo "[]")
          KV_ID=$(echo "$KV_LIST" | jq -r ".[] | select(.title==\"$KV_NAMESPACE_NAME\") | .id" | head -n 1)
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "Creating new KV namespace: $KV_NAMESPACE_NAME"
            KV_CREATE=$(npx wrangler kv:namespace create "$KV_NAMESPACE_NAME" --json)
            KV_ID=$(echo "$KV_CREATE" | jq -r '.id')
            echo "âœ… KV Namespace created: $KV_ID"
          else
            echo "âœ… KV Namespace already exists: $KV_ID"
          fi
          
          echo "kv_namespace_id=$KV_ID" >> $GITHUB_OUTPUT
          
          echo "âœ¨ Infrastructure setup complete!"

      - name: Update wrangler.toml
        run: |
          echo "ðŸ“ Updating wrangler.toml with resource IDs..."
          
          # Update D1 database ID
          sed -i "s/database_id = \".*\"/database_id = \"${{ steps.setup.outputs.d1_database_id }}\"/" wrangler.toml
          
          # Update KV namespace ID
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ steps.setup.outputs.kv_namespace_id }}\"/" wrangler.toml
          
          echo "âœ… wrangler.toml updated"
          cat wrangler.toml

  setup-database:
    runs-on: ubuntu-latest
    name: Setup Database Schema and Seed Data
    needs: setup-infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update wrangler.toml for database operations
        run: |
          sed -i "s/database_id = \".*\"/database_id = \"${{ needs.setup-infrastructure.outputs.d1_database_id }}\"/" wrangler.toml
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ needs.setup-infrastructure.outputs.kv_namespace_id }}\"/" wrangler.toml

      - name: Run Database Schema Migration
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ—„ï¸ Running database schema migration..."
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/schema.sql --remote
          echo "âœ… Schema migration complete"

      - name: Run Database Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”„ Running additional migrations..."
          
          # Migration 002 - FIDO enhancements (may fail if already applied)
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/migration_002_fido_enhancements.sql --remote || echo "âš ï¸ Migration 002 skipped (possibly already applied)"
          
          # Migration 003 - Site settings (may fail if already applied)
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/migration_003_site_settings.sql --remote || echo "âš ï¸ Migration 003 skipped (possibly already applied)"
          
          echo "âœ… Migrations complete"

      - name: Seed Database
        if: github.event.inputs.skip_database_seed != 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸŒ± Seeding database with initial data..."
          npx wrangler d1 execute "$D1_DATABASE_NAME" --file=./worker/src/db/seed.sql --remote
          echo "âœ… Database seeded successfully"
          echo "âš ï¸ Default users created:"
          echo "  - Admin: admin@vaultcloud.dev / admin123"
          echo "  - User: user@vaultcloud.dev / user123"

  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy Worker API
    needs: [setup-infrastructure, setup-database]
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update wrangler.toml for deployment
        run: |
          sed -i "s/database_id = \".*\"/database_id = \"${{ needs.setup-infrastructure.outputs.d1_database_id }}\"/" wrangler.toml
          sed -i "s/id = \"placeholder-kv-id\"/id = \"${{ needs.setup-infrastructure.outputs.kv_namespace_id }}\"/" wrangler.toml
          
          # Set production environment
          sed -i 's/ENVIRONMENT = "development"/ENVIRONMENT = "production"/' wrangler.toml

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Setting worker secrets..."
          
          # Set JWT secret
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | npx wrangler secret put JWT_SECRET
          fi
          
          # Set encryption key
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then
            echo "${{ secrets.ENCRYPTION_KEY }}" | npx wrangler secret put ENCRYPTION_KEY
          fi
          
          # Set Resend API key (optional)
          if [ -n "${{ secrets.RESEND_API_KEY }}" ]; then
            echo "${{ secrets.RESEND_API_KEY }}" | npx wrangler secret put RESEND_API_KEY
          fi
          
          echo "âœ… Secrets configured"

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          packageManager: npm

      - name: Get Worker URL
        id: worker-url
        run: |
          WORKER_URL="https://vaultcloud-api.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Worker deployed to: $WORKER_URL"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend to Cloudflare Pages
    needs: deploy-worker
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || format('https://vaultcloud-api.{0}.workers.dev', secrets.CLOUDFLARE_ACCOUNT_ID) }}
        run: |
          echo "ðŸ—ï¸ Building frontend..."
          echo "API URL: $VITE_API_URL"
          npm run build
          echo "âœ… Build complete"

      - name: Publish to Cloudflare Pages
        id: deploy-pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.PAGES_PROJECT_NAME }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-pages.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Worker**: https://vaultcloud-api.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **D1 Database**: ${{ needs.setup-infrastructure.outputs.d1_database_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **KV Namespace**: ${{ needs.setup-infrastructure.outputs.kv_namespace_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Security Notice" >> $GITHUB_STEP_SUMMARY
          echo "Default test users have been created. Please change passwords immediately!" >> $GITHUB_STEP_SUMMARY
